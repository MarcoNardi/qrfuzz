#!/bin/bash
set -e
cd "$(dirname "$BASH_SOURCE")"

log () {
    echo "[[1;34m$0[0m] $@"
}

ok () {
    echo "[[1;32mOK[0m] $@"
}

[[ -n "$ANDROID_HOME" ]] ||
    export ANDROID_HOME="$HOME/Android/Sdk"

log Installing Android SDK in $ANDROID_HOME
setup/android-sdk

if ! lsmod | grep -q v4l2loopback; then
    log 'Installing `v4l2loopback` kernel module'
    setup/v4l2loopback
else
    ok '`v4l2loopback` kernel module already loaded'
fi

if ! which ffmpeg &> /dev/null; then
    log Installing FFmpeg
    setup/ffmpeg
else
    ok ffmpeg already installed
fi

if ! which npm &> /dev/null; then
    log Installing Node.js
    setup/nodejs
else
    ok Node.js already installed
fi

# The setup will be triggered when either the driver or appium itself are missing
if ! appium driver list --installed 2>&1 | grep -q uiautomator2; then
    log Installing Appium
    setup/appium
else
    ok Appium already installed
fi
