#/bin/bash
set -e

# Automatically kill ffmpeg and the emulator on exit
trap '&> /dev/null killall -r ffmpeg qemu-system-.*' EXIT INT TERM

[[ -n "$ANDROID_HOME" ]] ||
    export ANDROID_HOME="$HOME/Android/Sdk"
which emulator adb &> /dev/null ||
    export PATH="$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$PATH"

qr_video=qr.mp4
qr_app_package=com.example.barcodescanner

# Enable dummy camera
if ! ( lsmod | grep -q v4l2loopback ); then
    echo 'Loading v4l2loopback kernel module...'
    sudo modprobe v4l2loopback
fi

# Find virtual camera device
device="/dev/$(ls /sys/devices/virtual/video4linux 2> /dev/null | head -1)"
if ! grep -q '^/dev/video[0-9]*$' <<< "$device"; then
    echo Virtual webcam not found >&2
    exit 1
fi

# Start video stream to virtual webcam
# Use video
ffmpeg &> /tmp/ffmpeg.log \
    -stream_loop -1 \
    -re -i "$qr_video" \
    -f v4l2 $device \
    &

# Wait for ffmpeg to start the stream
sleep 1
# Get webcam name from emulator
webcam=$(emulator -webcam-list | grep $device | grep -o 'webcam[0-9]*') || {
    echo Android emulator is unable to find the virtual webcam >&2
    exit 1
}

# Launch the emulator
emulator &> /tmp/emulator.log \
    -avd qrfuzz \
    -camera-back $webcam \
    &

# Download the QR scanner app
[[ -f $qr_app_package.apk ]] ||
    curl 'https://f-droid.org/repo/com.example.barcodescanner_13.apk' -o $qr_app_package.apk

echo Waiting for the emulator to start... >&2
adb wait-for-device
# The emulator could be still booting. Wait until it is actually ready
until adb shell pm list packages &> /dev/null; do
    sleep 2
done

# Install the app
if adb shell pm list packages | grep -q $qr_app_package; then
    until adb uninstall $qr_app_package &> /dev/null; do
        sleep 2
    done
fi
until adb install $qr_app_package.apk &> /dev/null; do
    sleep 2
done
# Automatically grant permission
adb shell pm grant $qr_app_package android.permission.CAMERA
# Launch the app
adb shell am start -n $qr_app_package/$qr_app_package.feature.tabs.BottomTabsActivity

# Keep logcat running
adb logcat
