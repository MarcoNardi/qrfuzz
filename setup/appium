#!/bin/bash
set -e
cd "$(realpath "$(dirname "$BASH_SOURCE")")/.."

log () {
    echo "[[1;34m$0[0m] $@"
}

# NVM might need its environment
[[ -n "$NVM_DIR" ]] || export NVM_DIR="$HOME/.nvm"
[[ -s "$NVM_DIR/nvm.sh" ]] && . "$NVM_DIR/nvm.sh"

which npm &> /dev/null || {
    log Installing dependency: Node.js
    setup/nodejs
}

which appium &> /dev/null || {
    log Installing Appium
    npm install -g appium ||
        # Might need root access
        sudo npm install -g appium
}

appium driver list --installed 2>&1 | grep -q uiautomator2 || {
    log Installing \`uiautomator2\` driver
    appium driver install uiautomator2
}
