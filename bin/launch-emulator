#!/bin/bash
set -e

pid_file=/tmp/emulator.pid

print_usage () {
    cat >&2 <<- EOF
	usage: launch-emulator [EMULATOR ARGS ...]
	Launch an emulator instance
	- Returns the emulator PID in \`/tmp/emulator.pid\`

	options:
	  -h, --help    show this message
	EOF
}

case "$1" in
    -h | --help)
        print_usage
        exit
        ;;
    *)  additional_args="$@";;
esac

if [[ -f "$pid_file" ]] && ps -p $(cat "$pid_file") &> /dev/null; then
    echo An emulator instance is already running >&2
    exit 2
fi

[[ -n "$ANDROID_HOME" ]] ||
    export ANDROID_HOME="$HOME/Android/Sdk"
which emulator adb &> /dev/null ||
    export PATH="$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$PATH"

which emulator adb &> /dev/null || {
    cat >&2 <<- EOF
	Android SDK not found
	It is expected to be in \$ANDROID_HOME: ${ANDROID_HOME/$HOME/\~}
	EOF
    read -p 'Do you want to install it? (Y/n) ' answer >&2
    if [[ "$answer" != [Nn] ]]; then
        setup/android-sdk
    else
        exit 1
    fi
}

# Get webcam name from emulator
webcam=$(emulator -webcam-list 2> /dev/null | grep "$device" | grep -o 'webcam[0-9]*') || {
    echo Android emulator is unable to find the virtual webcam >&2
    exit 1
}

# Launch the emulator
emulator &> /tmp/emulator.log \
    -avd qrfuzz \
    -camera-back $webcam \
    "$additional_args" \
    &

# Save the emulator PID
echo $! > "$pid_file"
