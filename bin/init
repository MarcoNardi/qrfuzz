#!/bin/bash
set -e
cd "$(realpath "$(dirname "$BASH_SOURCE")")/.."

initial_qr=test/qr.png

[[ -n "$ANDROID_HOME" ]] ||
    export ANDROID_HOME="$HOME/Android/Sdk"
which adb &> /dev/null ||
    export PATH="$ANDROID_HOME/platform-tools:$PATH"

which adb &> /dev/null || {
    cat >&2 <<- EOF
	Android SDK not found
	It is expected to be in \$ANDROID_HOME: ${ANDROID_HOME/$HOME/\~}
	EOF
    read -p 'Do you want to install it? (Y/n) ' answer >&2
    if [[ "$answer" != [Nn] ]]; then
        setup/android-sdk
    else
        exit 1
    fi
}

# Automatically kill ffmpeg and the emulator on exit
trap 'kill $ffmpeg_pid $emulator_pid &> /dev/null' EXIT INT TERM

# Start video stream
bin/stream "$initial_qr"
device=$(< /tmp/stream.device)
ffmpeg_pid=$(< /tmp/stream.pid)

# Wait for ffmpeg to start the stream
sleep 1

# Start emulator
bin/launch-emulator $device
emulator_pid=$(< /tmp/emulator.pid)

echo Waiting for the emulator to start
adb wait-for-device

# Now you should run the coordinator
