#!/bin/bash
set -e
cd "$(realpath "$(dirname "$BASH_SOURCE")")/.."

log () {
    echo "[[1;34m$0[0m] $@"
}
warning () {
    log "[[1;33mWARNING[0m] $@" >&2
}

print_help () {
    cat >&2 <<- EOF
	usage: fuzz [-h] APP
	Run fuzzing tests for APP

	arguments:
	  APP           the app to test
	options:
	  -h, --help    show this message
	EOF
}

initial_qr=test/qr-examples/qr1.png

[[ -n "$1" ]] || {
    print_help
    exit 1
}

case "$1" in
    -h | --help)
        print_help
        exit 0
        ;;
    *)  app="$1" ;;
esac

[[ -n "$ANDROID_HOME" ]] ||
    export ANDROID_HOME="$HOME/Android/Sdk"
which adb &> /dev/null ||
    export PATH="$ANDROID_HOME/platform-tools:$PATH"

which adb &> /dev/null || {
    cat >&2 <<- EOF
	Android SDK not found
	It is expected to be in \$ANDROID_HOME: ${ANDROID_HOME/$HOME/\~}
	EOF
    read -p 'Do you want to install it? (Y/n) ' answer >&2
    if [[ "$answer" != [Nn] ]]; then
        setup/android-sdk
    else
        exit 1
    fi
}

# Automatically kill the background services on exit
trap 'kill $stream_pid $appium_pid &> /dev/null' EXIT INT TERM

log Starting video stream to virtual camera
util/stream "$initial_qr"
device=$(< /tmp/stream.device)
stream_pid=$(< /tmp/stream.pid)

# Wait for ffmpeg to start the stream
sleep 2

# Check that an emulator is running
[[ -f /tmp/emulator.pid ]] && ps -p $(< /tmp/emulator.pid) &> /dev/null || {
    log Starting Android emulator
    util/launch-emulator "$device"
}

# Wait for the emulator to start and check that the app is installed
util/apk-install $app

log Starting Appium server
appium &> /tmp/appium.log \
    --base-path /wd/hub \
    -p 4723 \
    &
appium_pid=$!

# Wait for appium to start
sleep 5

emulator="$( \
    adb devices |
    grep emulator |
    sed 's/\(emulator-[0-9]*\).*/\1/'
)"

cd QRFuzz/tools/QRCodeFuzzer

[[ -d "data-tests/$app" ]] ||
    mkdir -p "data-tests/$app"
[[ -f "data-test/$app/fuzzer.json" ]] ||
    cat data-tests/app-example/fuzzer.json > "data-tests/$app/fuzzer.json"

log Starting fuzzing tests
node index.js "$app" "data-tests/$app" 4723 "$emulator" || {
    [[ $? = 130 ]] || {
        warning Fuzzer returned error code $?
        log Something may have gone wrong, try again
    }
}
