#!/bin/bash
set -e

if [[ $(uname) = Darwin ]]; then
    os=mac
    prefix=~/Library/Android/sdk
elif [[ $(uname) = Linux ]]; then
    os=linux
    prefix=~/Android/Sdk
else
    echo OS not supported >&2
    exit 1
fi

if uname -m | grep -Eq '^(arm|aarch)64$'; then
    arch=arm64-v8a
else
    arch=x86_64
fi
system_image="system-images;android-34;google_apis_playstore;$arch"
device=qrfuzz

[[ -d "$prefix" ]] || mkdir -p "$prefix/cmdline-tools"

# Get from curl
if ! [[ -d "$prefix/cmdline-tools/latest" ]]; then
    link="https://dl.google.com/android/repository/commandlinetools-$os-10406996_latest.zip"
    echo "Downloading Android SDK from $link"
    curl -Lo out.zip "$link"
    echo Extracting downloaded package...
    unzip -q out.zip -d "$prefix/cmdline-tools" && rm out.zip
    mv "$prefix/cmdline-tools/cmdline-tools" "$prefix/cmdline-tools/latest"
fi

echo yes | "$prefix/cmdline-tools/latest/bin/sdkmanager" \
    platform-tools \
    'platforms;android-34' \
    $system_image

echo Creating virtual device...
echo no | "$prefix/cmdline-tools/latest/bin/avdmanager" create avd > /dev/null \
    --force \
    -n $device \
    -k $system_image

# Enable buttons
sed -i'' -e 's/^hw\.keyboard=no/hw.keyboard=yes/' ~/.android/avd/$device.avd/config.ini
