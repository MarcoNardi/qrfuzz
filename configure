#!/bin/bash
set -e

script_dir="$(dirname "$(readlink -f "$BASH_SOURCE")")"

if [[ $(uname -m) = arm64 ]]; then
    arch=arm64-v8a
else
    arch=x86_64
fi
system_image="system-images;android-34;google_apis;$arch"
device=qrfuzz

if which brew &> /dev/null; then
    prefix="$(brew --prefix)/share/android-commandlinetools"
    which "$prefix/cmdline-tools/latest/bin/sdkmanager" > /dev/null ||
        brew install android-commandlinetools
else
    prefix=~/Library/Android/sdk
    [[ -d "$prefix" ]] || mkdir -p "$prefix/cmdline-tools"

    # Get from curl
    if ! [[ -d "$prefix/cmdline-tools/latest" ]]; then
        curl -L 'https://dl.google.com/android/repository/commandlinetools-mac-10406996_latest.zip' |
            tar -xpf -
        mv cmdline-tools "$prefix/cmdline-tools/latest"
    fi
fi

"$prefix/cmdline-tools/latest/bin/sdkmanager" --install \
    'platform-tools' \
    'platforms;android-34' \
    $system_image

echo Creating virtual device...
echo no | "$prefix/cmdline-tools/latest/bin/avdmanager" create avd > /dev/null \
    --force \
    -n $device \
    -k $system_image

# Enable buttons
sed -i'' -e 's/^hw\.keyboard=no/hw.keyboard=yes/' ~/.android/avd/$device.avd/config.ini
# Enable webcam
# might be something like webcam0, webcam1, ... you'll need to do some trial-and-error
sed -i'' -e 's/^hw\.camera\.back=emulated/hw.camera.back=webcam1/' ~/.android/avd/$device.avd/config.ini
